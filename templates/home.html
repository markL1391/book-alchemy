{% extends "base.html" %}

{% block title %}Library{% endblock %}

{% block content %}

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Search -->
<form action="{{ url_for('home') }}" method="GET" style="margin-bottom: 16px;">
  <input
    type="text"
    name="q"
    placeholder="Search title or author…"
    value="{{ q or '' }}"
  >
  <input type="hidden" name="sort" value="{{ sort_key or 'title' }}">
  <button type="submit">Search</button>

  {% if q %}
    <a href="{{ url_for('home', sort=sort_key or 'title') }}">Clear</a>
  {% endif %}
</form>

{% if q and books|length == 0 %}
  <p>No books match “{{ q }}”.</p>
{% endif %}

<!-- Sort -->
<p>
  Sort:
  {% if sort_key == "title" %}
    <strong>Title</strong>
  {% else %}
    <a href="{{ url_for('home', sort='title', q=q) }}">Title</a>
  {% endif %}
  |
  {% if sort_key == "author" %}
    <strong>Author</strong>
  {% else %}
    <a href="{{ url_for('home', sort='author', q=q) }}">Author</a>
  {% endif %}
</p>

{% if books|length == 0 %}
  <p>No books found. Add some books first.</p>
{% else %}
  <ul class="books">
    {% for book in books %}
      <li class="book">
        {% if book.isbn %}
          <img
            src="https://covers.openlibrary.org/b/isbn/{{ book.isbn }}-M.jpg?default=false"
            alt="Cover for {{ book.title }}"
            onerror="this.onerror=null; this.src='https://books.google.com/books/content?vid=ISBN{{ book.isbn }}&printsec=frontcover&img=1&zoom=1';"
          >
        {% endif %}

        <strong>{{ book.title }}</strong><br>
        <small>
          {{ book.author.name }}
          {% if book.publication_year %}
            · {{ book.publication_year }}
          {% endif %}
        </small>

        <!-- Delete -->
        <form
          action="{{ url_for('delete_book', book_id=book.id) }}"
          method="POST"
          style="margin-top: 10px;"
        >
          <button
            type="submit"
            onclick="return confirm('Delete {{ book.title }}?')"
          >
            Delete
          </button>
        </form>
      </li>
    {% endfor %}
  </ul>
{% endif %}

<p style="margin-top: 30px;">
  <a href="{{ url_for('add_author') }}">Add Author</a> ·
  <a href="{{ url_for('add_book') }}">Add Book</a>
</p>

{% endblock %}
